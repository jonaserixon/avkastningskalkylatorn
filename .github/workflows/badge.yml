name: Update PHPStan Level Gist

on:
  push:
    branches:
      - main
  schedule:
    - cron:  '0 0 * * *'
  workflow_dispatch:

jobs:
  update-gist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Extract PHPStan level
        id: phpstan-level
        run: |
          level=$(grep 'level:' ./phpstan/phpstan.neon | cut -d ':' -f2 | xargs)
          echo "::set-output name=level::$level"
      
      - name: Update Gist
        uses: conradj/gist-action@v2
        with:
          gist_id: ${{ secrets.STAN_GIST_ID }}
          filename: 'phpstan-level.json'
          token: ${{ secrets.GITHUB_TOKEN }}
          content: |
            {
              "schemaVersion": 1,
              "label": "phpstan",
              "message": "level ${{ steps.phpstan-level.outputs.level }}",
              "color": "blue"
            }
